#!/usr/bin/env sai-run

reference:
  fs require('fs')
  readline require('readline')
  stream require('stream')
  
object Test main

instance:
  pass empty
  fail empty
  ids blank

Instantiate task

  //@AnalyseParseTrace

  set tests to list
    Scope
    Loops
    Generators
    Promises
    Literals
    Syntax
    Comps
    RValues
    Operators
    Precedence
    Constructs
    Functions
    SetStatement
    Reference
    CompOrderOps
    Inheritance

  set startTime new ~Date
  ply tests
    try
      set suite to create it @
      suite.Execute
    catch
      debug error
      set @fail concat "Could not execute tests in ${it}"
  set endTime new ~Date
  debug 'Test time ${endTime-startTime}ms.'
  
  if @fail.length
    debug 'FAILED'
    ply @fail
      debug 'FAIL: ${it}'
    ~process.exit 1
  else
    debug 'SUCCESS'

// ok just ignore this right now
AnalyseParseTrace task
  set
    filename 'parse.trace'
    instream ~fs.createReadStream(filename)
    outstream new ~stream
    rl ~readline.createInterface(instream,outstream)
    ruletally blank

  rl.on 'line', task given line
    with line.split(/\s+/)
      set ruletally[.2] to (self default 0)+1

  rl.on 'close', task
    debug ruletally enlist by .1 desc limit 50 
    

